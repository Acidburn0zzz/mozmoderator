language: python
dist: xenial
addons:
  snaps:
  - name: aws-cli
    confinement: classic
    channel: latest/edge
services:
- docker
before_install:
- pip install flake8
- npm install -g eslint stylelint
script:
- flake8 moderator
- eslint 'moderator/moderate/static/js/*.js'
- stylelint 'moderator/moderate/static/css/*.css'
- docker build . -t "$ECR:$TRAVIS_COMMIT"
before_deploy:
- eval $(aws ecr get-login --no-include-email --region us-west-2)
deploy:
  provider: script
  on:
    all_branches: true
    condition: "$TRAVIS_BRANCH =~ ^(master|prod)$"
  script: docker push "$ECR:$TRAVIS_COMMIT"
env:
  global:
  - secure: "skgZLJXAISgtTGqIZGpz7+NwfhPTnls6bYgsZtmEi5f0xpESj7Ob3XVsT6u/UaHzw12A5oExbFHGum8edryif3MMzKozU1Emcus+mg+zeamaLDVMwrLfutJsR2L3QyEh2A5aDqdrYjUasIRRpHYgYpEoqDCP4A9DcBKb91m2Vq4="
  - ECR="$AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/moderator"
